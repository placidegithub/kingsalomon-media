{% extends "base.html" %}

{% block title %}Admin Panel - King Salomon Academy{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Admin Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2">
                            <i class="fas fa-cog me-2"></i>Administration Panel
                        </h2>
                        <p class="text-muted mb-0">Manage users, files, and system settings for King Salomon Academy.</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <span class="badge bg-danger">Administrator</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showAdminStats('users')">
                <div class="stats-number">{{ total_users }}</div>
                <div>Total Users</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showAdminStats('files')">
                <div class="stats-number">{{ total_files }}</div>
                <div>Total Files</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showAdminStats('images')">
                <div class="stats-number">{{ image_count }}</div>
                <div>Images</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showAdminStats('videos')">
                <div class="stats-number">{{ video_count }}</div>
                <div>Videos</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
    </div>

    <!-- Users Management -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <h4 class="mb-3">
                    <i class="fas fa-users me-2"></i>User Management
                </h4>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Approval</th>
                                <th>Files</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-2">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        {{ user.full_name }}
                                    </div>
                                </td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'primary' if user.role == 'teacher' else 'success' }}">
                                        {{ user.role.title() }}
                                    </span>
                                </td>
                                <td>
                                    {% set status = user.approval_status or 'approved' %}
                                    <span class="badge bg-{{ 'secondary' if status == 'pending' else 'success' if status == 'approved' else 'danger' }}">
                                        {{ status.title() }}
                                    </span>
                                </td>
                                <td>{{ user.uploaded_files|length }}</td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '-' }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewUserFiles({{ user.id }})" title="View files">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if status != 'approved' %}
                                        <a class="btn btn-sm btn-outline-success" href="{{ url_for('approve_user', user_id=user.id) }}" title="Approve">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        {% endif %}
                                        {% if status != 'rejected' %}
                                        <a class="btn btn-sm btn-outline-danger" href="{{ url_for('reject_user', user_id=user.id) }}" title="Reject">
                                            <i class="fas fa-times"></i>
                                        </a>
                                        {% endif %}
                                        {% if status != 'pending' %}
                                        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('pending_user', user_id=user.id) }}" title="Set Pending">
                                            <i class="fas fa-hourglass-half"></i>
                                        </a>
                                        {% endif %}
                                        {% if user.id != current_user.id %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteUser({{ user.id }}, '{{ user.full_name }}')" title="Delete user">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Files Management -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <h4 class="mb-3">
                    <i class="fas fa-files-o me-2"></i>File Management
                </h4>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="fileSearch" placeholder="Search files...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="fileFilter">
                            <option value="all">All Files</option>
                            <option value="image">Images</option>
                            <option value="video">Videos</option>
                            <option value="public">Public Only</option>
                            <option value="private">Private Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" onclick="location.reload()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Uploader</th>
                                <th>Category</th>
                                <th>Visibility</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="file-icon me-2 {{ file.file_type }}">
                                            <i class="fas fa-{{ 'image' if file.file_type == 'image' else 'video' }}"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ file.original_filename }}</div>
                                            {% if file.description %}
                                            <small class="text-muted">{{ file.description[:50] }}{% if file.description|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if file.file_type == 'image' else 'danger' }}">
                                        {{ file.file_type.title() }}
                                    </span>
                                </td>
                                <td>{{ "%.1f"|format(file.file_size / 1024) }} KB</td>
                                <td>{{ file.uploader.full_name }}</td>
                                <td>{{ file.category.title() }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if file.is_public else 'secondary' }}">
                                        {{ 'Public' if file.is_public else 'Private' }}
                                    </span>
                                </td>
                                <td>{{ file.upload_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-info" onclick="previewFile({{ file.id }}, '{{ file.file_type }}', '{{ file.original_filename }}')" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-sm btn-outline-success" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFile({{ file.id }})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal for User -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteUserMessage">Are you sure you want to delete this user?</p>
            </div>
            <div class="modal-footer">
                <form id="deleteUserForm" method="POST">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete User</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this file? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete File</button>
            </div>
        </div>
    </div>
</div>

<!-- User Files Modal -->
<div class="modal fade" id="userFilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userFilesContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalTitle">
                    <i class="fas fa-file me-2"></i>File Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="previewContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" id="downloadFromPreview">
                        <i class="fas fa-download me-2"></i>Download File
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteFile(fileId) {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    document.getElementById('confirmDelete').onclick = function() {
        window.location.href = '/delete/' + fileId;
    };
    modal.show();
}

function confirmDeleteUser(userId, fullName) {
    const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
    document.getElementById('deleteUserMessage').textContent = `Delete user "${fullName}"? This will remove all their files too.`;
    const form = document.getElementById('deleteUserForm');
    form.action = `/admin/users/${userId}/delete`;
    modal.show();
}

function viewUserFiles(userId) {
    // Placeholder for future AJAX loading
    document.getElementById('userFilesContent').innerHTML = '<p>Loading user files...</p>';
    const modal = new bootstrap.Modal(document.getElementById('userFilesModal'));
    modal.show();
}

// File search functionality
document.getElementById('fileSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const fileName = row.querySelector('td:first-child').textContent.toLowerCase();
        if (fileName.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// File filter functionality
document.getElementById('fileFilter').addEventListener('change', function() {
    const filterValue = this.value;
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (filterValue === 'all') {
            row.style.display = '';
        } else {
            const fileType = row.querySelector('.badge').textContent.toLowerCase();
            const visibility = row.querySelector('td:nth-child(6) .badge').textContent.toLowerCase();
            
            if (filterValue === 'image' && fileType === 'image') {
                row.style.display = '';
            } else if (filterValue === 'video' && fileType === 'video') {
                row.style.display = '';
            } else if (filterValue === 'public' && visibility === 'public') {
                row.style.display = '';
            } else if (filterValue === 'private' && visibility === 'private') {
                row.style.display = '';
            } else if (filterValue === 'all') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
});

// Admin statistics modal function
function showAdminStats(type) {
    let title, content;
    
    switch(type) {
        case 'users':
            title = 'User Statistics';
            content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-primary">{{ total_users }}</h4>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-success">{{ users|selectattr('role', 'equalto', 'student')|list|length }}</h4>
                            <p>Students</p>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-warning">{{ users|selectattr('role', 'equalto', 'teacher')|list|length }}</h4>
                            <p>Teachers</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-danger">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h4>
                            <p>Admins</p>
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'files':
            title = 'File Statistics';
            content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-primary">{{ total_files }}</h4>
                            <p>Total Files</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-success">{{ public_count }}</h4>
                            <p>Public Files</p>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-info">{{ "%.1f"|format(total_size / (1024*1024*1024)) }} GB</h4>
                            <p>Total Storage</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-warning">{{ files|selectattr('category', 'equalto', 'events')|list|length }}</h4>
                            <p>Event Files</p>
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'images':
            title = 'Image Statistics';
            content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-success">{{ image_count }}</h4>
                            <p>Total Images</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-primary">{{ files|selectattr('file_type', 'equalto', 'image')|selectattr('is_public', 'equalto', true)|list|length }}</h4>
                            <p>Public Images</p>
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'videos':
            title = 'Video Statistics';
            content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-danger">{{ video_count }}</h4>
                            <p>Total Videos</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-primary">{{ files|selectattr('file_type', 'equalto', 'video')|selectattr('is_public', 'equalto', true)|list|length }}</h4>
                            <p>Public Videos</p>
                        </div>
                    </div>
                </div>
            `;
            break;
    }
    
    // Create and show modal
    const modalHtml = `
        <div class="modal fade" id="adminStatsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('adminStatsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('adminStatsModal'));
    modal.show();
}

// File preview function (same as dashboard)
function previewFile(fileId, fileType, fileName) {
    const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    const modalTitle = document.getElementById('previewModalTitle');
    const previewContent = document.getElementById('previewContent');
    const downloadBtn = document.getElementById('downloadFromPreview');
    
    // Update modal title
    modalTitle.innerHTML = `<i class="fas fa-${fileType === 'image' ? 'image' : 'video'} me-2"></i>${fileName}`;
    
    // Set download button link
    downloadBtn.onclick = function() {
        window.location.href = `/download/${fileId}`;
    };
    
    // Show loading
    previewContent.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading preview...</p>
        </div>
    `;
    
    // Show modal
    modal.show();
    
    // Load content based on file type
    if (fileType === 'image') {
        previewContent.innerHTML = `
            <div class="image-preview-container">
                <img src="/preview/${fileId}" 
                     class="img-fluid rounded shadow" 
                     alt="${fileName}"
                     style="max-height: 70vh; max-width: 100%; object-fit: contain;"
                     onerror="showPreviewError()">
            </div>
        `;
    } else if (fileType === 'video') {
        previewContent.innerHTML = `
            <div class="video-preview-container">
                <video controls 
                       class="rounded shadow" 
                       style="max-height: 70vh; max-width: 100%;"
                       onerror="showPreviewError()">
                    <source src="/preview/${fileId}" type="video/mp4">
                    <source src="/preview/${fileId}" type="video/avi">
                    <source src="/preview/${fileId}" type="video/mov">
                    <source src="/preview/${fileId}" type="video/webm">
                    Your browser does not support the video tag.
                </video>
            </div>
        `;
    }
}

// Show error if preview fails
function showPreviewError() {
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <h5 class="mt-3 text-muted">Preview not available</h5>
            <p class="text-muted">This file cannot be previewed in the browser.</p>
            <p class="text-muted">You can still download it to view on your device.</p>
        </div>
    `;
}
</script>

<style>
.avatar-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: var(--secondary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.file-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
}

.file-icon.image {
    background-color: var(--success-color);
}

.file-icon.video {
    background-color: var(--accent-color);
}
</style>
{% endblock %}
