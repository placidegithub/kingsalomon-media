{% extends "base.html" %}

{% block title %}Dashboard - King Salomon Academy{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2">Welcome back, {{ current_user.full_name }}!</h2>
                        <p class="text-muted mb-0">Manage your media files and access shared content from the academy community.</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <span class="badge bg-primary">{{ current_user.role.title() }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showTotalFiles()">
                <div class="stats-number">{{ total_files }}</div>
                <div>Total Files</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showUserFiles()">
                <div class="stats-number">{{ user_file_count }}</div>
                <div>Your Files</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showStorageDetails()">
                <div class="stats-number">{{ "%.1f"|format(total_size / (1024*1024*1024)) }}</div>
                <div>GB Storage Used</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card clickable-card" onclick="showPublicFiles()">
                <div class="stats-number">{{ public_files|length }}</div>
                <div>Public Files</div>
                <small class="text-light opacity-75">Click to view details</small>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <h4 class="mb-3">
                    <i class="fas fa-cloud-upload-alt me-2"></i>Upload New Files
                </h4>
                
                <form id="uploadForm" method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
                    <div id="uploadArea" class="upload-area">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--secondary-color); margin-bottom: 20px;"></i>
                        <h5>Drag & Drop files here or click to browse</h5>
                        <p class="text-muted">Supports images (JPG, PNG, GIF) and videos (MP4, AVI, MOV)</p>
                        <input type="file" id="fileInput" name="file" multiple accept="image/*,video/*" style="display: none;">
                    </div>
                    
                    <div id="fileList" class="mt-3"></div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="general">General</option>
                                <option value="events">School Events</option>
                                <option value="academic">Academic</option>
                                <option value="sports">Sports</option>
                                <option value="cultural">Cultural</option>
                                <option value="graduation">Graduation</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="is_public" name="is_public">
                                <label class="form-check-label" for="is_public">
                                    Make this file public (visible to all academy members)
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="2" placeholder="Add a description for your files..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-2"></i>Upload Files
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search files...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterSelect">
                <option value="all">All Files</option>
                <option value="image">Images Only</option>
                <option value="video">Videos Only</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-primary w-100" onclick="location.reload()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
        </div>
    </div>

    <!-- Your Files Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <h4 class="mb-3">
                    <i class="fas fa-folder me-2"></i>Your Files
                </h4>
                
                {% if user_files %}
                <div class="row">
                    {% for file in user_files %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="file-card" data-type="{{ file.file_type }}">
                            <div class="d-flex align-items-start">
                                <div class="file-icon {{ file.file_type }}">
                                    <i class="fas fa-{{ 'image' if file.file_type == 'image' else 'video' }}"></i>
                                </div>
                                <div class="file-info flex-grow-1">
                                    <h6 class="file-name">{{ file.original_filename }}</h6>
                                    <div class="file-meta">
                                        <small class="d-block">{{ file.file_size // 1024 }} KB</small>
                                        <small class="d-block">{{ file.upload_date.strftime('%Y-%m-%d') }}</small>
                                        <small class="d-block">
                                            <span class="badge bg-{{ 'success' if file.is_public else 'secondary' }}">
                                                {{ 'Public' if file.is_public else 'Private' }}
                                            </span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-info btn-sm" onclick="previewFile({{ file.id }}, '{{ file.file_type }}', '{{ file.original_filename }}')" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-success btn-sm flex-fill">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                                <button class="btn btn-danger btn-sm delete-btn" onclick="deleteFile({{ file.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-folder-open" style="font-size: 4rem; color: var(--light-text);"></i>
                    <h5 class="mt-3 text-muted">No files uploaded yet</h5>
                    <p class="text-muted">Upload your first file using the form above!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Public Files Section -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <h4 class="mb-3">
                    <i class="fas fa-globe me-2"></i>Public Files from Academy Community
                </h4>
                
                {% if public_files %}
                <div class="row">
                    {% for file in public_files %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="file-card" data-type="{{ file.file_type }}">
                            <div class="d-flex align-items-start">
                                <div class="file-icon {{ file.file_type }}">
                                    <i class="fas fa-{{ 'image' if file.file_type == 'image' else 'video' }}"></i>
                                </div>
                                <div class="file-info flex-grow-1">
                                    <h6 class="file-name">{{ file.original_filename }}</h6>
                                    <div class="file-meta">
                                        <small class="d-block">By: {{ file.uploader.full_name }}</small>
                                        <small class="d-block">{{ file.file_size // 1024 }} KB</small>
                                        <small class="d-block">{{ file.upload_date.strftime('%Y-%m-%d') }}</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-info btn-sm" onclick="previewFile({{ file.id }}, '{{ file.file_type }}', '{{ file.original_filename }}')" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-primary btn-sm flex-fill">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users" style="font-size: 4rem; color: var(--light-text);"></i>
                    <h5 class="mt-3 text-muted">No public files available</h5>
                    <p class="text-muted">Be the first to share a file with the academy community!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this file? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete File</button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Detail Modals -->
<!-- Total Files Modal -->
<div class="modal fade" id="totalFilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-files-o me-2"></i>Total Files in System
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-primary">{{ total_files }}</h4>
                            <p>Total Files</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-success">{{ user_files|selectattr('file_type', 'equalto', 'image')|list|length }}</h4>
                            <p>Images</p>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-danger">{{ user_files|selectattr('file_type', 'equalto', 'video')|list|length }}</h4>
                            <p>Videos</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h4 class="text-warning">{{ public_files|length }}</h4>
                            <p>Public Files</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Files Modal -->
<div class="modal fade" id="userFilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Your Files ({{ user_file_count }})
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if user_files %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Category</th>
                                <th>Visibility</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in user_files %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{{ 'image' if file.file_type == 'image' else 'video' }} me-2 text-{{ 'success' if file.file_type == 'image' else 'danger' }}"></i>
                                        {{ file.original_filename }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if file.file_type == 'image' else 'danger' }}">
                                        {{ file.file_type.title() }}
                                    </span>
                                </td>
                                <td>{{ "%.1f"|format(file.file_size / 1024) }} KB</td>
                                <td>{{ file.category.title() }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if file.is_public else 'secondary' }}">
                                        {{ 'Public' if file.is_public else 'Private' }}
                                    </span>
                                </td>
                                <td>{{ file.upload_date.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-folder-open text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">No files uploaded yet</h5>
                    <p class="text-muted">Start uploading your files to see them here!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Storage Details Modal -->
<div class="modal fade" id="storageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-hdd me-2"></i>Storage Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h3 class="text-primary">{{ "%.1f"|format(total_size / (1024*1024*1024)) }} GB</h3>
                            <p>Total Storage Used</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-card text-center">
                            <h3 class="text-success">{{ "%.1f"|format((total_size / (1024*1024*1024)) * 0.1) }} GB</h3>
                            <p>Available Space</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Storage Breakdown:</h6>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar bg-success" style="width: 60%">Images: 60%</div>
                        <div class="progress-bar bg-danger" style="width: 40%">Videos: 40%</div>
                    </div>
                    <small class="text-muted">Storage usage by file type</small>
                </div>
                
                <div class="mt-3">
                    <h6>File Size Distribution:</h6>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <h5 class="text-success">{{ user_files|selectattr('file_size', 'lt', 1024*1024)|list|length }}</h5>
                            <small>Small Files (&lt;1MB)</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <h5 class="text-warning">{{ user_files|selectattr('file_size', 'ge', 1024*1024)|selectattr('file_size', 'lt', 10*1024*1024)|list|length }}</h5>
                            <small>Medium Files (1-10MB)</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <h5 class="text-danger">{{ user_files|selectattr('file_size', 'ge', 10*1024*1024)|list|length }}</h5>
                            <small>Large Files (&gt;10MB)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Public Files Modal -->
<div class="modal fade" id="publicFilesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-globe me-2"></i>Public Files ({{ public_files|length }})
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if public_files %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Type</th>
                                <th>Uploader</th>
                                <th>Category</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in public_files %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-{{ 'image' if file.file_type == 'image' else 'video' }} me-2 text-{{ 'success' if file.file_type == 'image' else 'danger' }}"></i>
                                        {{ file.original_filename }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if file.file_type == 'image' else 'danger' }}">
                                        {{ file.file_type.title() }}
                                    </span>
                                </td>
                                <td>{{ file.uploader.full_name }}</td>
                                <td>{{ file.category.title() }}</td>
                                <td>{{ file.upload_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-info" onclick="previewFile({{ file.id }}, '{{ file.file_type }}', '{{ file.original_filename }}')" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-sm btn-primary" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">No public files available</h5>
                    <p class="text-muted">Be the first to share a file with the academy community!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- File Preview Modal -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalTitle">
                    <i class="fas fa-file me-2"></i>File Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="previewContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" id="downloadFromPreview">
                        <i class="fas fa-download me-2"></i>Download File
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteFile(fileId) {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    document.getElementById('confirmDelete').onclick = function() {
        window.location.href = '/delete/' + fileId;
    };
    modal.show();
}

// Statistics modal functions
function showTotalFiles() {
    const modal = new bootstrap.Modal(document.getElementById('totalFilesModal'));
    modal.show();
}

function showUserFiles() {
    const modal = new bootstrap.Modal(document.getElementById('userFilesModal'));
    modal.show();
}

function showStorageDetails() {
    const modal = new bootstrap.Modal(document.getElementById('storageModal'));
    modal.show();
}

function showPublicFiles() {
    const modal = new bootstrap.Modal(document.getElementById('publicFilesModal'));
    modal.show();
}

// File preview function
function previewFile(fileId, fileType, fileName) {
    const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    const modalTitle = document.getElementById('previewModalTitle');
    const previewContent = document.getElementById('previewContent');
    const downloadBtn = document.getElementById('downloadFromPreview');
    
    // Update modal title
    modalTitle.innerHTML = `<i class="fas fa-${fileType === 'image' ? 'image' : 'video'} me-2"></i>${fileName}`;
    
    // Set download button link
    downloadBtn.onclick = function() {
        window.location.href = `/download/${fileId}`;
    };
    
    // Show loading
    previewContent.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading preview...</p>
        </div>
    `;
    
    // Show modal
    modal.show();
    
    // Load content based on file type
    if (fileType === 'image') {
        previewContent.innerHTML = `
            <div class="image-preview-container">
                <img src="/preview/${fileId}" 
                     class="img-fluid rounded shadow" 
                     alt="${fileName}"
                     style="max-height: 70vh; max-width: 100%; object-fit: contain;"
                     onerror="showPreviewError()">
            </div>
        `;
    } else if (fileType === 'video') {
        previewContent.innerHTML = `
            <div class="video-preview-container">
                <video controls 
                       class="rounded shadow" 
                       style="max-height: 70vh; max-width: 100%;"
                       onerror="showPreviewError()">
                    <source src="/preview/${fileId}" type="video/mp4">
                    <source src="/preview/${fileId}" type="video/avi">
                    <source src="/preview/${fileId}" type="video/mov">
                    <source src="/preview/${fileId}" type="video/webm">
                    Your browser does not support the video tag.
                </video>
            </div>
        `;
    }
}

// Show error if preview fails
function showPreviewError() {
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <h5 class="mt-3 text-muted">Preview not available</h5>
            <p class="text-muted">This file cannot be previewed in the browser.</p>
            <p class="text-muted">You can still download it to view on your device.</p>
        </div>
    `;
}
</script>
{% endblock %}
